<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OS Maps API | Additional Zoom Levels Example | OpenLayers</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css" />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<!-- Map display -->
<div id="map"></div>

<!-- Layer control UI -->
<div class="layer-controls">
  <strong>Layers</strong><br>
  <label><input type="checkbox" id="osToggle" checked> Ordnance Survey</label><br>
  <label><input type="checkbox" id="heatmapToggle" checked> Strava Heatmap</label>
</div>


<style>
    .my_css_class {
        //filter: grayscale(100%) invert(1);
    }
    .layer-controls {
      position: absolute;
      top: 60px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 4px;
      font-family: Arial, sans-serif;
    }
</style>


<script src="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.19.0/proj4.min.js"></script>
<script>

    const apiKey = 'HiKqP4vPPc1kZEOfFrtoqPLaN4qo4S0B';

    // Setup the EPSG:27700 (British National Grid) projection.
    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs");
    ol.proj.proj4.register(proj4);

    const tilegrid = new ol.tilegrid.TileGrid({
        resolutions: [ 896.0, 448.0, 224.0, 112.0, 56.0, 28.0, 14.0, 7.0, 3.5, 1.75, 0.875, 0.4375, 0.21875, 0.109375 ],
        origin: [ -238375.0, 1376256.0 ]
    });

    // Initialize the map object.
    // The 'minResolution' and 'maxResolution' options are used to define the resolutions
    // at which the layers will be visible.
    os_leisure_layer = new ol.layer.Tile({
                maxZoom: 9,
                source: new ol.source.XYZ({
                    url: 'https://api.os.uk/maps/raster/v1/zxy/Leisure_27700/{z}/{x}/{y}.png?key=' + apiKey,
                    projection: 'EPSG:27700',
                    tileGrid: tilegrid
                }),
                className: 'my_css_class'
            });
    os_road_layer = new ol.layer.Tile({
                minZoom: 9,
                source: new ol.source.XYZ({
                    url: 'https://api.os.uk/maps/raster/v1/zxy/Road_27700/{z}/{x}/{y}.png?key=' + apiKey,
                    projection: 'EPSG:27700',
                    tileGrid: tilegrid
                })
            });
    heatmap_layer = new ol.layer.Tile({
                    minZoom:1, maxZoom:20,
                    source: new ol.source.XYZ({
                            url: 'http://192.168.1.30:4331/identified/globalheat/all/bluered/{z}/{x}/{y}.png?v=19',
                            projection: 'EPSG:3857'
                    })
            });

    // --- Decode URL ---
    const params = new URLSearchParams(window.location.search);
    const lon = parseFloat(params.get("lon"));
    const lat = parseFloat(params.get("lat"));
    const zoom = parseFloat(params.get("zoom"));
    const hasValidParams = !isNaN(lon) && !isNaN(lat) && !isNaN(zoom);

    // --- Create the view ---
    viewer = new ol.View({
            projection: 'EPSG:27700',
            extent: [ -238375.0, 0.0, 900000.0, 1376256.0 ],
            resolutions: tilegrid.getResolutions(),
            minZoom: 0,
            maxZoom: 13,
            //center: [ 337297, 503695 ], // is NY377041 Ambleside
            //center: [ 340485, 730265 ],   // is NO404302 Dundee
            center: hasValidParams ? [lon, lat] : [ 340485, 730265 ],   // is NO404302 Dundee
            zoom: hasValidParams ? zoom : 6
        })

    // --- Create the map ---
    const map = new ol.Map({
        layers: [ os_leisure_layer, os_road_layer, heatmap_layer ],
        target: 'map',
        view: viewer,
    });

    // --- UI Controls ---
    document.getElementById("osToggle").addEventListener("change", (e) => {
        os_leisure_layer.setVisible(e.target.checked);
        os_road_layer.setVisible(e.target.checked);
    });

    document.getElementById("heatmapToggle").addEventListener("change", (e) => {
        heatmap_layer.setVisible(e.target.checked);
    });

    // --- Update URL as map is moved
    viewer.on("change:center", updateURL);
    viewer.on("change:resolution", updateURL);
    let updateTimeout = null;
    function updateURL() {
        // Throttle updates so the URL doesn't update too fast while panning
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            const center = viewer.getCenter(); // not using toLonLat
            const zoom = viewer.getZoom();
            const newParams = new URLSearchParams(window.location.search);
            newParams.set("lon", center[0].toFixed(1));
            newParams.set("lat", center[1].toFixed(1));
            newParams.set("zoom", zoom.toFixed(0));
            const newUrl = `${window.location.pathname}?${newParams.toString()}`;
            window.history.replaceState({}, "", newUrl);
        }, 200);
    }


</script>

</body>
</html>
